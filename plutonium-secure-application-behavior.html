<script>
    'use strict';
    window.PlutoniumBehaviors = window.PlutoniumBehaviors || {};
    PlutoniumBehaviors.SecureApplicationBehavior = {
        properties: {
            session: {
                type: Object,
                notify: true,
                value: null
            },
            registering: {
                type: Boolean,
                notify: true,
                value: false
            },
            prefix: {
                type: String,
                reflectToAttribute: true,
                notify: true
            },
            landingPage: {
                type: String,
                reflectToAttribute: true,
                notify: true
            },
            page: {
                type: String,
                reflectToAttribute: true,
                observer: '_pageChanged'
            }
        },
        observers: [
            '_observeSession(session,registering)',
            '_routePageChanged(routeData.page, landingPage)',
            '_pageChanged(page, prefix)'
        ],
        listeners: {
            'unauthorized': 'onUnauthorized',
            'authorized': 'onAuthorized',
            'login': 'onLogin',
            'registrate': 'onRegistration',
            'passwordreset': 'onPasswordReset',
            'forgottenpassword': 'onForgottenPassword'
        },
        _observeSession: function (session, registering) {
            if (!session && !registering) {
                this.$.loginWidget.open();
            } else if (!session && registering) {
                this.$.logonWidget.open();
            } else {
                this.$.loginWidget.close();
                this.$.logonWidget.close();
            }
        },
        _routePageChanged: function (page, landingPage) {
            this.page = page || landingPage;
        },
        _pageChanged: function (page, prefix) {
            if (prefix) {
                // load page import on demand.
                this.importHref(
                        this.resolveUrl(prefix + '-' + page + '.html'), null, null, true);
            }
        },
        onLogin: function (event, detail) {
            this.$.loginWidget.open();
        },
        onRegistration: function (event, detail) {
            this.$.logonWidget.open();
        },
        onPasswordReset: function (event, detail) {
            this.$.passwordResetWidget.open();
        },
        onForgottenPassword: function (event, detail) {
            this.$.forgottenPasswordWidget.open();
        },
        onUnauthorized: function (event, detail) {
            this.$.mainToast.text = detail.message;
            this.$.mainToast.show();
            this._observeSession(this.session, this.registering);
        },
        onAuthorized: function (event, detail) {
            this.$.mainToast.text = detail.message;
            this.$.mainToast.show();
            this.session = detail;
        }
    };
</script>